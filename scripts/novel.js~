/**
 * Novel JavaScript 
 *
 * author: zachfedor
 * url: http://zachfedor.com
 * license: MIT
 * version: 2.0
 */

// set global variables
var quoteContentTimeout, quoteAuthorTimeout, typeTimeout;

// initialize the page
function init() {
    var content = document.getElementById("quoteBlock");

    if (content != null) {
        quotes();
    }
}

// ajax call to request quote contents
function quotes() {
    new Ajax.Request("quotes.xml",
    {
        method: "GET",
        onSuccess: showQuotes,
        onFailure: ajaxFailed,
        onException: ajaxFailed
    });
}

// display randomly chosen quote
function showQuotes(ajax) {
    // load all quote nodes into array
    var quotes = ajax.responseXML.getElementsByTagName("quote");

    var i = Math.floor(Math.random()*quotes.length);

    // use random number to grab one array element
    // and grab it's content and author
    var content = quotes[i].getElementsByTagName("content")[0];
    var contentValue = content.firstChild.nodeValue;
    var author = quotes[i].getElementsByTagName("author")[0];
    var authorValue = "-" + author.firstChild.nodeValue + "-";

    // place strings into hidden html elements for now
    document.getElementById("hideContent").innerHTML = contentValue;
    document.getElementById("hideAuthor").innerHTML = authorValue;

    // unhide the element letter by letter
    // using type() defined below
    quoteContentTimeout = setTimeout(function(){type("hideContent", "quoteContent", 35)},1000);

    // account for time to complete quote before beginning author
    var t = ((contentValue.length + 1) * 50) + 2000;
    quoteAuthorTimeout = setTimeout(function(){type("hideAuthor", "quoteAuthor", 200)},t);
}

// typewriter-esque display of string letter by letter
//      hide = id of hidden element containing string to type
//      display = id of visible element containing type output
//      time = delay between characters typed
function type(hide, display, time) {
    // grab the string
    var input = document.getElementById(hide).innerHTML;

    // add character to visible element
    document.getElementById(display).innerHTML += input.charAt(0);
    // and remove it from the hidden one
    document.getElementById(hide).innerHTML = input.substring(1);

    // wait for next character and repeat
    typeTimeout = setTimeout(function(){
        ((0 < input.length - 1) ? type(hide, display, time) : false);
    }, time);
}

// error message if necessary
function ajaxFailed(ajax, exception) {
    var msg = "Error making AJAX request:\n\n";
    if (exception) {
        msg += "Exception: " + exception.message;
    } else {
        msg += "Server status:\n" + ajax.status + " " + ajax.statusText + "\n\nServer response text:\n" + ajax.responseText;
    }

    // remove this line to test AJAX failure
    // keep it for client friendly error message
    msg = "I apologize, but there seems to be a problem with my site. Hopefully it didn't cause an issue. Would you mind letting me know via the Contact page? Unless that's broken, too..." 
    alert(msg);
}
